name: Daily MAC Refresh

on:
  schedule:
    # Run at 6:00 AM UTC every day (after US markets close)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Refresh indicator cache
        run: |
          echo "=== Refreshing indicator cache ==="
          response=$(curl -s -w "\n%{http_code}" -X POST "https://white-glacier-0020b2f1e.2.azurestaticapps.net/api/refresh")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response:"
          echo "$body" | jq '.' 2>/dev/null || echo "$body"

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 207 ]; then
            echo "✓ Indicator cache refresh completed"
            
            # Check individual sources
            fred_status=$(echo "$body" | jq -r '.sources.FRED.status // "unknown"')
            cftc_status=$(echo "$body" | jq -r '.sources.CFTC.status // "unknown"')
            
            echo "FRED Status: $fred_status"
            echo "CFTC Status: $cftc_status"
          else
            echo "✗ Refresh failed with status $http_code"
          fi

      - name: Trigger MAC calculation
        run: |
          echo "=== Triggering MAC calculation ==="
          response=$(curl -s -w "\n%{http_code}" "https://white-glacier-0020b2f1e.2.azurestaticapps.net/api/mac/demo")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          
          if [ "$http_code" -eq 200 ]; then
            echo "✓ MAC calculation successful"
            
            mac_score=$(echo "$body" | jq -r '.mac_score // "N/A"')
            data_source=$(echo "$body" | jq -r '.data_source // "N/A"')
            cache_age=$(echo "$body" | jq -r '.cache_age_seconds // "N/A"')
            db_connected=$(echo "$body" | jq -r '.db_connected // "N/A"')

            echo "MAC Score: $mac_score"
            echo "Data Source: $data_source"
            echo "Cache Age (seconds): $cache_age"
            echo "DB Connected: $db_connected"
            
            # Show pillar scores
            echo "Pillar Scores:"
            echo "$body" | jq -r '.pillar_scores | to_entries[] | "  \(.key): \(.value.score) (\(.value.status))"'
          else
            echo "✗ MAC calculation failed with status $http_code"
            echo "$body"
            exit 1
          fi
      - name: Refresh backtest cache
        run: |
          echo "=== Refreshing backtest cache ==="
          echo "This may take a few minutes as it computes historical data..."
          
          # Use longer timeout for backtest (it fetches ~20 years of data)
          response=$(curl -s -w "\n%{http_code}" -X POST --max-time 300 "https://white-glacier-0020b2f1e.2.azurestaticapps.net/api/refresh/backtest")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          
          if [ "$http_code" -eq 200 ]; then
            echo "✓ Backtest cache refresh completed"
            
            data_points=$(echo "$body" | jq -r '.data_points // "N/A"')
            crises=$(echo "$body" | jq -r '.crises_analyzed // "N/A"')
            accuracy=$(echo "$body" | jq -r '.prediction_accuracy // "N/A"')
            
            echo "Data Points: $data_points"
            echo "Crises Analyzed: $crises"
            echo "Prediction Accuracy: $accuracy"
          else
            echo "⚠ Backtest refresh failed (non-critical)"
            echo "$body"
          fi