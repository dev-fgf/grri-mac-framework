<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRRI-MAC Framework | Market Absorption Capacity</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>GRRI-MAC</h1>
                <span class="subtitle">Market Absorption Capacity Framework</span>
            </div>
            <nav class="nav">
                <a href="#dashboard" class="nav-link active">Dashboard</a>
                <a href="#backtest" class="nav-link">Backtest</a>
                <a href="#simulator" class="nav-link">Simulator</a>
                <a href="#thresholds" class="nav-link">Thresholds</a>
            </nav>
            <div class="status-indicator" id="apiStatus">
                <span class="status-dot"></span>
                <span class="status-text">Connecting...</span>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="section-header">
                <h2>Current MAC Assessment</h2>
                <button class="btn btn-primary" onclick="refreshMAC()">Refresh</button>
            </div>

            <div class="dashboard-grid">
                <!-- Data Status Banner -->
                <div class="card card-full data-status-card" id="dataStatusCard">
                    <div class="data-status">
                        <div class="data-source">
                            <span class="source-icon" id="sourceIcon">&#9679;</span>
                            <span class="source-label">Data Source:</span>
                            <span class="source-value" id="dataSource">Checking...</span>
                        </div>
                        <div class="data-refresh">
                            <span class="refresh-label">Last Updated:</span>
                            <span class="refresh-value" id="lastRefresh">--</span>
                            <span class="refresh-ago" id="refreshAgo"></span>
                        </div>
                        <div class="data-indicators" id="dataIndicators">
                            <span class="indicator-count">-- indicators</span>
                        </div>
                    </div>
                </div>

                <!-- MAC Stress Index Card -->
                <div class="card card-large mac-score-card">
                    <div class="card-header">
                        <h3>Market Stress Index</h3>
                        <span class="timestamp" id="macTimestamp">--</span>
                    </div>
                    <div class="mac-score-display">
                        <div class="score-gauge">
                            <canvas id="macGauge"></canvas>
                            <div class="score-value" id="macScoreValue">--</div>
                        </div>
                        <div class="score-details">
                            <div class="interpretation" id="macInterpretation">Loading...</div>
                            <div class="multiplier">
                                <span class="label">Transmission Multiplier</span>
                                <span class="value" id="macMultiplier">--</span>
                                <span class="tier" id="macTier">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pillar Stress Scores -->
                <div class="card pillar-card">
                    <div class="card-header">
                        <h3>Pillar Stress Levels</h3>
                    </div>
                    <div class="pillar-grid" id="pillarGrid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Pillar Chart -->
                <div class="card chart-card">
                    <div class="card-header">
                        <h3>Stress Radar</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="pillarRadar"></canvas>
                    </div>
                </div>

                <!-- Breach Alerts -->
                <div class="card alerts-card">
                    <div class="card-header">
                        <h3>Active Alerts</h3>
                    </div>
                    <div class="alerts-list" id="alertsList">
                        <div class="alert-placeholder">No active breaches</div>
                    </div>
                </div>

                <!-- Historical Chart -->
                <div class="card card-full history-card">
                    <div class="card-header">
                        <h3>Stress Index History</h3>
                        <div class="chart-controls">
                            <button class="btn btn-sm" id="togglePillars" onclick="togglePillarLines()">Show Pillars</button>
                            <select id="historyRange" onchange="updateHistoryRange()">
                                <option value="7">7 Days</option>
                                <option value="30" selected>30 Days</option>
                                <option value="90">90 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="history-chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                    <div class="chart-legend" id="chartLegend">
                        <span class="legend-item mac"><span class="legend-color"></span>Stress Index</span>
                        <span class="legend-item liquidity hidden"><span class="legend-color"></span>Liquidity Stress</span>
                        <span class="legend-item valuation hidden"><span class="legend-color"></span>Valuation Stress</span>
                        <span class="legend-item positioning hidden"><span class="legend-color"></span>Positioning Stress</span>
                        <span class="legend-item volatility hidden"><span class="legend-color"></span>Volatility Stress</span>
                        <span class="legend-item policy hidden"><span class="legend-color"></span>Policy Stress</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Backtest Section -->
        <section id="backtest" class="section">
            <div class="section-header">
                <h2>Historical Backtest</h2>
                <button class="btn btn-primary" onclick="loadBacktestHistory()">Load Historical Data</button>
            </div>

            <!-- Historical MAC Chart with Crisis Events -->
            <div class="card card-full backtest-chart-card">
                <div class="card-header">
                    <h3>Market Stress Index with Crisis Events (Real FRED Data, 2006-Present)</h3>
                    <div class="chart-controls">
                        <select id="backtestInterval" onchange="loadBacktestHistory()">
                            <option value="7">Weekly</option>
                            <option value="14">Bi-weekly</option>
                            <option value="30">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="backtest-chart-container">
                    <canvas id="backtestChart"></canvas>
                </div>
                <div class="chart-legend backtest-legend">
                    <span class="legend-item mac"><span class="legend-color"></span>Stress Index</span>
                    <span class="legend-item crisis"><span class="legend-color"></span>Crisis Event</span>
                    <span class="legend-item zone-comfortable"><span class="legend-color"></span>Comfortable (&lt;0.35)</span>
                    <span class="legend-item zone-cautious"><span class="legend-color"></span>Cautious (0.35-0.50)</span>
                    <span class="legend-item zone-stretched"><span class="legend-color"></span>Stretched (0.50-0.65)</span>
                    <span class="legend-item zone-critical"><span class="legend-color"></span>Critical (&gt;0.65)</span>
                </div>
                <div class="backtest-loading" id="backtestLoading">
                    <span>Loading historical FRED data...</span>
                </div>
            </div>

            <!-- Crisis Prediction Analysis -->
            <div class="backtest-summary" id="backtestSummary">
                <div class="summary-card">
                    <span class="summary-value" id="btTotal">--</span>
                    <span class="summary-label">Data Points</span>
                </div>
                <div class="summary-card">
                    <span class="summary-value" id="btAvgLead">--</span>
                    <span class="summary-label">Avg Lead Time (days)</span>
                </div>
                <div class="summary-card">
                    <span class="summary-value" id="btAvgStretched">--</span>
                    <span class="summary-label">Avg Days Stretched</span>
                </div>
                <div class="summary-card highlight">
                    <span class="summary-value" id="btWarningRate">--%</span>
                    <span class="summary-label">Warning Rate</span>
                </div>
                <div class="summary-card success">
                    <span class="summary-value" id="btPredictionAcc">--%</span>
                    <span class="summary-label">Prediction Accuracy</span>
                </div>
            </div>

            <!-- Crisis Event Analysis Table -->
            <div class="card card-full">
                <div class="card-header">
                    <h3>Crisis Prediction Analysis</h3>
                </div>
                <div class="backtest-results" id="backtestResults">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Crisis Event</th>
                                <th>Event Date</th>
                                <th>Stress at Event</th>
                                <th>First Warning</th>
                                <th>Days of Warning</th>
                                <th>Days Stretched</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="backtestTableBody">
                            <tr><td colspan="7" class="placeholder">Click "Load Historical Data" to analyze crisis predictions</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Simulator Section -->
        <section id="simulator" class="section">
            <div class="section-header">
                <h2>Shock Simulator</h2>
            </div>

            <div class="simulator-grid">
                <div class="card simulator-inputs">
                    <div class="card-header">
                        <h3>Input Parameters</h3>
                    </div>
                    <div class="input-group">
                        <label>Shock Magnitude</label>
                        <input type="range" id="shockMagnitude" min="0.5" max="3" step="0.1" value="1">
                        <span class="range-value" id="shockValue">1.0x</span>
                    </div>
                    <div class="input-group">
                        <label>GRRI Country Modifier</label>
                        <input type="range" id="grriModifier" min="0.8" max="1.5" step="0.05" value="1">
                        <span class="range-value" id="grriValue">1.00x</span>
                    </div>
                    <div class="input-group">
                        <label>MAC Score Override (optional)</label>
                        <input type="range" id="macOverride" min="0" max="1" step="0.05" value="0.5">
                        <span class="range-value" id="macOverrideValue">0.50</span>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="runSimulation()">
                        Simulate Impact
                    </button>
                </div>

                <div class="card simulator-output">
                    <div class="card-header">
                        <h3>Simulation Results</h3>
                    </div>
                    <div class="simulation-results" id="simulationResults">
                        <div class="result-equation">
                            <span class="eq-part">Market Impact</span>
                            <span class="eq-equals">=</span>
                            <span class="eq-part" id="eqShock">Shock</span>
                            <span class="eq-times">×</span>
                            <span class="eq-part" id="eqGrri">GRRI</span>
                            <span class="eq-times">×</span>
                            <span class="eq-part" id="eqMac">MAC</span>
                        </div>
                        <div class="result-impact">
                            <span class="impact-label">Total Market Impact</span>
                            <span class="impact-value" id="impactValue">--</span>
                        </div>
                        <div class="result-tier" id="riskTier">
                            <span class="tier-label">Risk Tier:</span>
                            <span class="tier-value">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Thresholds Section -->
        <section id="thresholds" class="section">
            <div class="section-header">
                <h2>Calibrated Thresholds</h2>
            </div>

            <div class="thresholds-grid" id="thresholdsGrid">
                <!-- Populated by JavaScript -->
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <span>GRRI-MAC Framework v1.0</span>
            <span>Market Absorption Capacity Assessment Tool</span>
            <a href="https://github.com/dev-fgf/grri-mac-framework" target="_blank">GitHub</a>
        </div>
    </footer>

    <script src="app.js"></script>
</body>
</html>
