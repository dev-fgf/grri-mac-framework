<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAC Framework | Market Stress Monitor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="brand-icon">◈</span>
            <span class="brand-text">MAC Framework</span>
            <span class="brand-version">v4.5</span>
        </div>
        <div class="nav-links">
            <a href="#dashboard" class="nav-link active" data-section="dashboard">Dashboard</a>
            <a href="#backtest" class="nav-link" data-section="backtest">Backtest</a>
            <a href="#methodology" class="nav-link" data-section="methodology">Methodology</a>
        </div>
        <div class="nav-status">
            <span class="status-dot" id="statusDot"></span>
            <span class="status-text" id="statusText">Connecting...</span>
        </div>
    </nav>

    <main class="main-content">
        <!-- Data Source Health Banner (admin) -->
        <div class="data-health-banner" id="dataHealthBanner" style="display: none;">
            <span class="health-icon">&#9888;</span>
            <span class="health-text" id="dataHealthText"></span>
            <button class="health-dismiss" onclick="this.parentElement.style.display='none'">&times;</button>
        </div>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <!-- Hero: Current Stress Level -->
            <div class="hero-card">
                <div class="hero-left">
                    <div class="stress-gauge">
                        <canvas id="stressGauge"></canvas>
                        <div class="gauge-center">
                            <div class="gauge-value" id="stressValue">--</div>
                            <div class="gauge-label">Stress Index</div>
                        </div>
                    </div>
                </div>
                <div class="hero-right">
                    <div class="status-badge" id="statusBadge">Loading...</div>
                    <p class="status-description" id="statusDescription">
                        Analyzing market conditions...
                    </p>
                    <div class="meta-info">
                        <div class="meta-item">
                            <span class="meta-label">Data Source</span>
                            <span class="meta-value" id="dataSource">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Last Updated</span>
                            <span class="meta-value" id="lastUpdated">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Transmission Multiplier</span>
                            <span class="meta-value" id="multiplier">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7 Pillars Grid -->
            <div class="section-header">
                <h2>7-Pillar Stress Assessment</h2>
                <span class="section-badge">Real-time</span>
            </div>
            <div class="pillars-grid" id="pillarsGrid">
                <!-- Generated by JS -->
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
                <!-- Radar Chart -->
                <div class="chart-card">
                    <div class="card-header">
                        <h3>Stress Radar</h3>
                    </div>
                    <div class="chart-container radar-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <!-- History Chart -->
                <div class="chart-card chart-card-wide">
                    <div class="card-header">
                        <h3>Stress Index History</h3>
                        <div class="chart-controls">
                            <span class="loading-indicator" id="historyLoading">Loading...</span>
                            <select id="historyRange" onchange="updateHistoryChart()">
                                <option value="30">30 Days</option>
                                <option value="90">90 Days</option>
                                <option value="180" selected>6 Months</option>
                                <option value="365">1 Year</option>
                                <option value="730">2 Years</option>
                                <option value="1825">5 Years</option>
                                <option value="3650">10 Years</option>
                                <option value="7300">20 Years</option>
                                <option value="19710">Full History (1971+)</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container history-container" id="historyContainer">
                        <div class="chart-loading-overlay" id="historyOverlay">
                            <div class="spinner"></div>
                            <span>Loading data...</span>
                        </div>
                        <canvas id="historyChart"></canvas>
                    </div>
                    <div class="chart-legend" id="historyLegend">
                        <button class="legend-btn active" data-index="0">Composite</button>
                        <button class="legend-btn" data-index="1">Liquidity</button>
                        <button class="legend-btn" data-index="2">Valuation</button>
                        <button class="legend-btn" data-index="3">Positioning</button>
                        <button class="legend-btn" data-index="4">Volatility</button>
                        <button class="legend-btn" data-index="5">Policy</button>
                        <button class="legend-btn" data-index="6">Contagion</button>
                        <button class="legend-btn" data-index="7">Priv Credit</button>
                        <span class="legend-divider">|</span>
                        <label class="toggle-btn" title="Caldara-Iacoviello GPR Index (secondary axis)">
                            <input type="checkbox" id="gprToggle" onchange="toggleGPR()">
                            <span class="toggle-label">GPR Index</span>
                        </label>
                        <label class="toggle-btn" title="FGF Geopolitical Risk Supercycle Tracker (coming soon)">
                            <input type="checkbox" id="grsToggle" disabled>
                            <span class="toggle-label grs-label">GRS Tracker <span class="coming-soon">(soon)</span></span>
                        </label>
                        <label class="toggle-btn" title="Show historical crisis events as vertical markers">
                            <input type="checkbox" id="historyCrisisToggle" onchange="toggleCrisisEvents()" checked>
                            <span class="toggle-label">Crisis Events</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div class="alerts-section" id="alertsSection" style="display: none;">
                <div class="alert-banner" id="alertBanner">
                    <span class="alert-icon">⚠</span>
                    <span class="alert-text" id="alertText"></span>
                </div>
            </div>
        </section>

        <!-- Backtest Section -->
        <section id="backtest" class="section">
            <div class="section-header">
                <h2>54-Year Historical Backtest</h2>
                <span class="section-badge">1971-2025</span>
            </div>

            <!-- Backtest Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="btObservations">2,814</div>
                    <div class="stat-label">Weekly Observations</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-value" id="btTPR">81.5%</div>
                    <div class="stat-label">True Positive Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="btCrises">22/27</div>
                    <div class="stat-label">Crises Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="btLeadTime">42</div>
                    <div class="stat-label">Avg Days Warning</div>
                </div>
            </div>

            <!-- Backtest Chart -->
            <div class="chart-card">
                <div class="card-header">
                    <h3>Historical Stress Index with Crisis Events</h3>
                    <div class="chart-controls">
                        <select id="backtestStart" onchange="loadBacktestData()">
                            <option value="1971-01-01">Full History (1971)</option>
                            <option value="1990-01-01">1990-Present</option>
                            <option value="2000-01-01">2000-Present</option>
                            <option value="2006-01-01" selected>2006-Present</option>
                            <option value="2020-01-01">2020-Present</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container backtest-container">
                    <canvas id="backtestChart"></canvas>
                </div>
                <div class="zone-legend">
                    <span class="zone-item comfortable">Comfortable (&lt;0.42)</span>
                    <span class="zone-item cautious">Cautious (0.42-0.49)</span>
                    <span class="zone-item stretched">Stretched (0.49-0.58)</span>
                    <span class="zone-item critical">Critical (&gt;0.58)</span>
                    <span class="zone-item crisis">● Crisis Event</span>
                </div>
                <div class="crisis-legend">
                    <span class="crisis-marker extreme">Extreme</span>
                    <span class="crisis-marker high">High</span>
                    <span class="crisis-marker moderate">Moderate</span>
                </div>
            </div>

            <!-- Crisis Table -->
            <div class="table-card">
                <div class="card-header">
                    <h3>Crisis Detection Analysis</h3>
                </div>
                <div class="table-container">
                    <table class="data-table" id="crisisTable">
                        <thead>
                            <tr>
                                <th>Crisis Event</th>
                                <th>Date</th>
                                <th>Stress Level</th>
                                <th>Warning Days</th>
                                <th>Detection</th>
                            </tr>
                        </thead>
                        <tbody id="crisisTableBody">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Methodology Section -->
        <section id="methodology" class="section">
            <div class="section-header">
                <h2>Methodology</h2>
            </div>

            <div class="methodology-grid">
                <div class="method-card">
                    <h4>Stress Index Calculation</h4>
                    <p>The MAC Stress Index measures market vulnerability. Higher values indicate greater stress and reduced shock absorption capacity.</p>
                    <code>Stress Index = 1 - MAC Score = 1 - (Σ Pillar Scores / 7)</code>
                </div>

                <div class="method-card">
                    <h4>7-Pillar Framework</h4>
                    <ul>
                        <li><strong>Liquidity:</strong> SOFR-IORB spread, CP-Treasury spread</li>
                        <li><strong>Valuation:</strong> Term premium, IG/HY credit spreads</li>
                        <li><strong>Positioning:</strong> CFTC futures positioning data</li>
                        <li><strong>Volatility:</strong> VIX level and term structure</li>
                        <li><strong>Policy:</strong> Fed funds room, balance sheet, PCE</li>
                        <li><strong>Contagion:</strong> Cross-currency basis, credit ratios</li>
                        <li><strong>Private Credit:</strong> Leveraged loan conditions</li>
                    </ul>
                </div>

                <div class="method-card">
                    <h4>Stress Thresholds</h4>
                    <p class="calibration-note">Empirically calibrated from 54 years of data (1971-2025)</p>
                    <div class="threshold-list">
                        <div class="threshold comfortable">COMFORTABLE: &lt;0.42 — Normal conditions (~45% of history)</div>
                        <div class="threshold cautious">CAUTIOUS: 0.42-0.49 — Elevated vigilance (~30%)</div>
                        <div class="threshold stretched">STRETCHED: 0.49-0.58 — Reduced capacity (~18%)</div>
                        <div class="threshold critical">CRITICAL: &gt;0.58 — High vulnerability (~7%)</div>
                    </div>
                </div>

                <div class="method-card">
                    <h4>Data Sources & Updates</h4>
                    <p>Primary data from FRED (Federal Reserve Economic Data). Updated weekly on Saturdays. Historical backtest uses validated proxy indicators for pre-1986 data gaps (realized volatility, Moody's spreads).</p>
                </div>

                <div class="method-card comparison-card">
                    <h4>Comparison Overlays</h4>
                    <div class="overlay-info">
                        <div class="overlay-item">
                            <span class="overlay-badge gpr">GPR</span>
                            <div class="overlay-details">
                                <strong>Caldara-Iacoviello Geopolitical Risk Index</strong>
                                <p>Newspaper-based measure of geopolitical threats and events. Published in <em>American Economic Review</em> (2022). Measures the <em>cause</em> (geopolitical shocks) while MAC measures the <em>effect</em> (market vulnerability).</p>
                                <span class="overlay-meta">Source: matteoiacoviello.com | Coverage: 1900-present | Index: 1900-2019=100</span>
                            </div>
                        </div>
                        <div class="overlay-item coming-soon-item">
                            <span class="overlay-badge grs">GRS</span>
                            <div class="overlay-details">
                                <strong>FGF Geopolitical Risk Supercycle (GRS) Tracker</strong>
                                <p>GRRI-based measure of country-level risk across 4 pillars: <em>Political</em> (governance, conflict), <em>Economic</em> (macro stability, sanctions), <em>Social</em> (HDI, inequality, unrest), and <em>Environmental</em> (climate risk, disasters). 29 variables from World Bank, IMF, UNDP, V-Dem, and more.</p>
                                <span class="overlay-meta status-coming">In Development — Data sources documented</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <span>MAC Framework v4.5 — 7 Pillars, 54-Year Backtest (1971-2025)</span>
        <a href="https://github.com/dev-fgf/grri-mac-framework" target="_blank">GitHub</a>
    </footer>

    <script src="app.js"></script>
</body>
</html>
